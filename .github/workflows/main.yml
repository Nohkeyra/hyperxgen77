- name: Prepare deployment folder
  run: |
    echo "=== Checking for existing built files ==="
    
    # Option 1: Use already-built files from appsgeyser-upload/www/
    if [ -f "appsgeyser-upload/www/index.html" ]; then
      echo "Found built files in appsgeyser-upload/www/"
      # Check if it's the built version
      if grep -q "assets/index\." appsgeyser-upload/www/index.html; then
        echo "This is a BUILT index.html (has assets/)"
      else
        echo "This is a DEV index.html (needs build)"
      fi
      
      # Clean root and copy
      find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' ! -name 'appsgeyser-upload' -exec rm -rf {} +
      cp -r appsgeyser-upload/www/* .
      rm -rf appsgeyser-upload
    
    # Option 2: Use dist/ folder from build
    elif [ -d "dist" ]; then
      echo "Found dist/ folder from build"
      find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
      cp -r dist/* .
    
    # Option 3: Build failed, use what we have
    else
      echo "WARNING: No built files found. Using current files."
      # At least make sure we have index.html
      if [ ! -f "index.html" ]; then
        echo "ERROR: No index.html found!"
        exit 1
      fi
    fi
    
    echo "=== Final files ==="
    ls -la
